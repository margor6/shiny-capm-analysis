---
title: "Nieliniowa Analiza Modelu CAPM"
author: "Marcin GÃ³rski"
date: "11-11-2025"
output: 
  ioslides_presentation:
    widescreen: true
    smaller: true
    css: mstyle.css
---

## Wprowadzenie i Cel Projektu

### Cel analizy

GÅ‚Ã³wnym celem projektu jest **porÃ³wnanie dwÃ³ch modeli ekonometrycznych** opisujÄ…cych zwroty z akcji wybranej przez uÅ¼ytkownika spÃ³Å‚ki, np. Apple (AAPL) w oparciu o zwroty z wybranego rynku, np. (S&P 500):

1.  **Model A**: Klasyczny, liniowy model **CAPM**.
2.  **Model B**: Nieliniowy (kwadratowy) model **Testu Treynora-Mazuy**.

DalszÄ… czÄ™Å›Ä‡ tej prezentacji oprzemy wÅ‚aÅ›nie na tych dwÃ³ch zestawach danych.

### Pytanie badawcze

> Czy klasyczny model CAPM jest wystarczajÄ…cy? Czy znajdujemy statystyczne dowody na istnienie nieliniowoÅ›ci (tzw. "market timing"), co sugerowaÅ‚oby, Å¼e dziaÅ‚ania spÃ³Å‚ki zaleÅ¼Ä… od ich przewidywaÅ„ na temat rynku?

## O Danych ğŸ“Š

### Å¹rÃ³dÅ‚o i Zmienne

* **Dane**: Dzienne ceny zamkniÄ™cia (skorygowane) dla spÃ³Å‚ki **Apple Inc. (AAPL)** oraz indeksu **S&P 500 (^GSPC)**.
* **Å¹rÃ³dÅ‚o**: Pobrano z **Yahoo Finance** przy uÅ¼yciu pakietu `quantmod`.
* **Okres**: `r "2020-01-01"` do `r Sys.Date()`.
* **Zmienne Modelowe**:
    * $y$: Dzienna stopa zwrotu z akcji Apple.
    * $x$: Dzienna stopa zwrotu z indeksu S&P 500.

---

### Przygotowanie danych (fragment kodu)

```{r, echo=TRUE, eval=FALSE}
#Pobieramy dane
dane_spolki <- getSymbols("AAPL", src = "yahoo", 
                          auto.assign = F)
dane_rynku <- getSymbols("^GSPC", src = "yahoo", 
                         auto.assign = F)

#Obliczamy stopy zwrotu
zwrot_spolki <- dailyReturn(Ad(dane_spolki))
zwrot_rynku <- dailyReturn(Ad(dane_rynku))

#Tworzymy ramke danych
dane <- merge(zwrot_spolki, zwrot_rynku)
colnames(dane) <- c("y", "x")
# ... itd.
```

## O Metodzie ğŸ“ˆ

### Model A: Klasyczny Liniowy CAPM

Model ten zakÅ‚ada staÅ‚Ä…, liniowÄ… zaleÅ¼noÅ›Ä‡ miÄ™dzy zwrotem ze spÃ³Å‚ki a rynkiem.

$$
R_{i} - R_{f} = \alpha + \beta (R_{m} - R_{f}) + \epsilon
$$
*Po uproszczeniu (pomijajÄ…c $R_f$ dla danych dziennych):*
$$
y = \alpha + \beta x + \epsilon
$$
* **$R_{i}$ (lub $y$):** Zwrot z inwestycji (zmienna objaÅ›niana).
* **$R_{m}$ (lub $x$):** Zwrot z rynku (zmienna objaÅ›niajÄ…ca).
* **$R_{f}$:** Stopa wolna od ryzyka (pomijana w uproszczeniu).
* **$\alpha$ (Alfa):** Wyraz wolny, ponadprzeciÄ™tny zwrot, niewyjaÅ›nionego przez rynek.
* **$\beta$ (Beta):** Miara **ryzyka systematycznego** (wraÅ¼liwoÅ›Ä‡ na rynek).
* **$\epsilon$ (Epsilon):** SkÅ‚adnik losowy, szum.

---

### Model B: Test Treynora-Mazuy (Kwadratowy)

Model ten testuje hipotezÄ™ "market timing" poprzez dodanie czÅ‚onu kwadratowego.

$$
y = \alpha + \beta x + \gamma x^2 + \epsilon
$$

* $\gamma$ (**NieliniowoÅ›Ä‡**): To dodatkowy, kluczowy parametr.
    * JeÅ›li $\gamma > 0$ i jest istotne, sugeruje to **wypukÅ‚oÅ›Ä‡ (âˆª)**. SpÃ³Å‚ka reaguje mocniej na ekstremalne ruchy rynku.
    * JeÅ›li $\gamma < 0$ i jest istotne, sugeruje to **wklÄ™sÅ‚oÅ›Ä‡ (âˆ©)**. SpÃ³Å‚ka stabilizuje siÄ™ podczas ekstremalnych ruchÃ³w.

### Metoda Wyboru Modelu: AIC

> Jak wybraÄ‡ miÄ™dzy modelem prostym a zÅ‚oÅ¼onym?

UÅ¼ywamy **Kryterium Informacyjnego Akaike (AIC)**.
* AIC nagradza za dobre dopasowanie do danych, ale **karze za zÅ‚oÅ¼onoÅ›Ä‡** (liczbÄ™ parametrÃ³w).
* **Zasada: Wybieramy model z NIÅ»SZÄ„ wartoÅ›ciÄ… AIC.**

## Wyniki Analizy ğŸ”

### Estymacja Modeli (Kod R)

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, results='hide'}
library(quantmod)
library(ggplot2)

#Pobieranie danych
dane_spolki <- getSymbols("AAPL", src = "yahoo", from = "2020-01-01", auto.assign = FALSE)
dane_rynku <- getSymbols("^GSPC", src = "yahoo", from = "2020-01-01", auto.assign = FALSE)

#Przygotowanie danych
zwrot_spolki <- dailyReturn(Ad(dane_spolki))
zwrot_rynku <- dailyReturn(Ad(dane_rynku))
dane <- merge(zwrot_spolki, zwrot_rynku)
colnames(dane) <- c("y", "x")
dane <- na.omit(dane)
dane$x_kwadrat <- dane$x^2
dane_df <- as.data.frame(dane)

#Estymacja Modeli
model_A <- lm(y ~ x, data = dane_df)
model_B <- lm(y ~ x + x_kwadrat, data = dane_df)
```

---

### Wyniki: PorÃ³wnanie Modeli (AIC)

PorÃ³wnujemy oba modele przy uÅ¼yciu funkcji `AIC()` i formatujemy wynik za pomocÄ… `knitr::kable()`.

```{r, echo=TRUE, eval=TRUE}
#Tworzymy tabelÄ™ porÃ³wnawczÄ… AIC
tabela_aic <- AIC(model_A, model_B)
rownames(tabela_aic) <- c("Model A (Liniowy)", "Model B (Kwadratowy)")

#UÅ¼ywamy kable do ladnego wyswietlania
knitr::kable(tabela_aic, 
             caption = "PorÃ³wnanie wartoÅ›ci AIC dla obu modeli", 
             digits = 2)
```

**Wniosek:** Model B (Kwadratowy) posiada **niÅ¼szÄ… wartoÅ›Ä‡ AIC**, co sugeruje, Å¼e oferuje on lepszy kompromis miÄ™dzy dopasowaniem a zÅ‚oÅ¼onoÅ›ciÄ….

## Wyniki: Wizualizacja PorÃ³wnawcza

<div class="columns-2">

<div>

```{r, echo=FALSE, eval=TRUE, fig.align='center', warning=FALSE, message=FALSE, out.width="95%"}
#Dodajemy przewidywania z obu modeli
dane_df$pred_A <- predict(model_A)
dane_df$pred_B <- predict(model_B)

#Rysujemy wykres 
ggplot(dane_df, aes(x = x, y = y)) +
  geom_point(alpha = 0.1, color = "grey50") + 
  geom_line(aes(y = pred_A, color = "Model A (Liniowy)"), size = 1) +
  geom_line(aes(y = pred_B, color = "Model B (Kwadratowy)"), size = 1, linetype = "dashed") +
  scale_color_manual(name = "Modele", values = c("blue", "red")) +
  labs(title = "PorÃ³wnanie dopasowania modeli CAPM",
       x = "Dzienna stopa zwrotu rynku (S&P 500)",
       y = "Dzienna stopa zwrotu spÃ³Å‚ki (Apple)") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")
```

</div>
<div>

NaÅ‚oÅ¼enie obu linii regresji na chmurÄ™ punktÃ³w pozwala wizualnie oceniÄ‡ rÃ³Å¼nicÄ™.

<br>

**Wniosek:** Czerwona, przerywana linia (Model B) wykazuje lekkÄ… **wypukÅ‚oÅ›Ä‡ (âˆª)**, lepiej dopasowujÄ…c siÄ™ do danych w skrajnych punktach (podczas krachÃ³w i euforii). RÃ³Å¼nica z pewnoÅ›ciÄ… nie jest tu wielka, co zgadza siÄ™ z obliczonymi wartoÅ›ciami AIC.

</div>
</div>

## Wyniki: Interpretacja ParametrÃ³w (Model B)

Skupiamy siÄ™ na wybranym przez AIC Modelu B. Sprawdzamy statystycznÄ… istotnoÅ›Ä‡ obliczonych parametrÃ³w, korzystajÄ…c z testu t-Studenta.
```{r, echo=F, warning=F, eval=T}
library(knitr)
#Wyswietlamy podsumowanie wybranego modelu
summary_B <- summary(model_B)

#Drukujemy tylko tabelÄ™ wsp., bo caÅ‚e summary() siÄ™ nie miesci, a tak jest czytelniej
kable(summary_B$coefficients, 
      digits = c(5, 4, 3, 4), # Liczba miejsc po przecinku dla kaÅ¼dej kolumny
      caption = "Oszacowane parametry dla Modelu B (Kwadratowego)")
```

**Interpretacja:**

* **Alfa (Intercept):** `r round(summary_B$coefficients[1, 1], 5)` - Jest **statystycznie nieistotna** (p-value > 0.05), co sugeruje, Å¼e nie ma statystycznych podstaw by twierdziÄ‡, Å¼e spÃ³Å‚ka generowaÅ‚a stopy zwrotu inne niÅ¼ wynikaÅ‚oby to z rynku.
* **Beta (x):** `r round(summary_B$coefficients[2, 1], 3)` - Bardzo istotna, spÃ³Å‚ka jest agresywna (Beta > 1).
* **Beta 2 (x\_kwadrat):** `r round(summary_B$coefficients[3, 1], 3)` - **Jest statystycznie istotna.** (p-value < 0.05). To jest dowÃ³d na istnienie nieliniowoÅ›ci (market timing).
* **Skoryg. R-kwadrat:** `r round(summary_B$adj.r.squared, 3)` (nie w tabeli) - Model wyjaÅ›nia ok. **`r round(summary_B$adj.r.squared*100, 1)`%** zmiennoÅ›ci spÃ³Å‚ki.

---

### Wyniki: Hipoteza o normalnoÅ›ci Reszt

Sprawdzamy zaÅ‚oÅ¼enie o normalnoÅ›ci reszt dla modelu B.

> $H_0$: Reszty majÄ… rozkÅ‚ad normalny.

```{r, echo=TRUE, eval=TRUE}
#Test Shapiro-Wilka na resztach (limit 5000)
reszty_B <- residuals(model_B)
if(length(reszty_B) > 5000) {
  shapiro.test(sample(reszty_B, 5000))
} else {
  shapiro.test(reszty_B)
}
```
**Wniosek:** p-value jest ekstremalnie maÅ‚e (< 0.05), wiÄ™c **odrzucamy $H_0$**. Reszty nie sÄ… normalne.

---

### Wyniki: NormalnoÅ›Ä‡ Reszt (wizualnie)

Wykres Q-Q potwierdza brak normalnoÅ›ci.

```{r, echo=FALSE, eval=TRUE, fig.align='center'}
#Wykres Q-Q
par(mfrow = c(1,2), oma=c(0,0,2,0)) # Ustawienie dwÃ³ch wykresÃ³w
hist(reszty_B, breaks = 100, main = "Histogram reszt", xlab="Reszty", col="grey")
qqnorm(reszty_B, main = "Wykres Q-Q reszt")
qqline(reszty_B, col = "red", lwd = 2)
title("Diagnostyka reszt modelu B", outer=TRUE)
```

**Interpretacja:** Wykresy (szczegÃ³lnie Q-Q) pokazujÄ… wystÄ™powanie wartoÅ›ci odstajÄ…cych. Ekstremalne zdarzenia (krachy, euforie) sÄ… czÄ™stsze niÅ¼ w rozkÅ‚adzie normalnym. 


## Wnioski KoÅ„cowe

1.  **Model kwadratowy (Model B) okazaÅ‚ siÄ™ lepszy** od klasycznego, liniowego modelu CAPM (na podstawie niÅ¼szego AIC).
2.  ZnaleÅºliÅ›my **istotny statystycznie**, przy ${\alpha}$=0.05, parametr $\gamma$ (przy $x^2$), co jest dowodem na **nieliniowÄ… zaleÅ¼noÅ›Ä‡** miÄ™dzy zwrotami z Apple a rynkiem (tzw. market timing).
3.  Oznacza to, Å¼e klasyczny model CAPM jest **niewystarczajÄ…cy** do peÅ‚nego opisu ryzyka spÃ³Å‚ki Apple w badanym okresie.
4.  Diagnostyka reszt wykazaÅ‚a brak normalnoÅ›ci (wartoÅ›ci odstajÄ…ce), co potwierdza, Å¼e model moÅ¼na by dalej rozwijaÄ‡ (np. o modele GARCH).


## Inne spÃ³Å‚ki dajÄ…ce ciekawe wyniki:

* **Advanced Micro Devices (AMD)** - model kwadratowy z ${\gamma}$ = 1.6 - spÃ³Å‚ka agresywna

* **The Boeing Company (BO)** - model kwadratowy z ${\gamma}$ < 0 (wykres wklÄ™sÅ‚y) - spÃ³Å‚ka stabilna

* **ETF na zÅ‚oto (GLD)** - model liniowy (ale wyjaÅ›niajÄ…cy jedynie 1.6% zmiennoÅ›ci!)

## UÅ¼yte Pakiety ğŸ“¦

### `quantmod`

* **Autor:** Jeffrey A. Ryan oraz Joshua M. Ulrich.
* **Cel:** Pakiet `quantmod` (Quantitative Financial Modelling) to zestaw narzÄ™dzi do pobierania, analizowania i wizualizowania danych finansowych.
* **Wybrane funkcje:**
    * `getSymbols(Ticker, src = "yahoo")`: SÅ‚uÅ¼y do pobierania danych historycznych z rÃ³Å¼nych ÅºrÃ³deÅ‚ (np. Yahoo Finance, FRED). W naszym projekcie pobraliÅ›my "AAPL" i "^GSPC".
    * `dailyReturn(x)`: Oblicza stopy zwrotu (domyÅ›lnie arytmetyczne).
    * `Ad(x)`: Ekstrahuje kolumnÄ™ "Adjusted" (skorygowana cena zamkniÄ™cia) z pobranego obiektu `xts`.

---

### `ggplot2`

* **Autor:** Hadley Wickham.
* **Cel:** Najpopularniejszy pakiet do wizualizacji danych w R. Pozwala na budowanie wykresÃ³w.
* **Wybrane funkcje:**
    * `ggplot(data, aes(...))`: Inicjalizuje obiekt wykresu i definiuje parametry.
    * `geom_point()`: Dodaje warstwÄ™ punktÃ³w (wykres rozrzutu).
    * `geom_line()`: Dodaje warstwÄ™ linii.
    * `labs()`: SÅ‚uÅ¼y do definiowania wszystkich etykiet (tytuÅ‚, podtytuÅ‚, osie, legenda).




## DziÄ™kujÄ™ za uwagÄ™!
